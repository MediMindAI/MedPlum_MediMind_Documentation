<!-- ═══════════════════════════════════════════════════════════════ -->
<!-- Technical Documentation - System Architecture -->
<!-- ═══════════════════════════════════════════════════════════════ -->

<div class="architecture-technical-docs">

  <h3 id="technical-overview">Technical Overview</h3>
  <p>
    The registration module is built on a <strong>Layer-based architecture</strong>, where each layer
    is responsible for specific functionality and communication occurs only between adjacent layers.
  </p>

  <div class="doc-callout doc-callout-info doc-callout-simple">
    <strong>Technology Stack:</strong>
    <ul>
      <li><strong>Frontend:</strong> React 18 + TypeScript 5.x</li>
      <li><strong>Backend:</strong> Medplum FHIR R4 Server (api.medplum.com)</li>
      <li><strong>State Management:</strong> React Hooks + Context API</li>
      <li><strong>UI Framework:</strong> Mantine UI Components</li>
    </ul>
  </div>

  <div class="doc-table-container">
    <table class="doc-table">
      <thead>
        <tr>
          <th>Layer</th>
          <th>Responsibility</th>
          <th>Examples</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>UI Layer</strong></td>
          <td>User interface, forms, event handling</td>
          <td><code>RegistrationVisitModal</code>, <code>PatientForm</code>, <code>RegistrationVisitWizard</code></td>
        </tr>
        <tr>
          <td><strong>Hooks Layer</strong></td>
          <td>Business logic, state management, side effects</td>
          <td><code>useRegistrationVisitForm</code>, <code>useDepartments</code></td>
        </tr>
        <tr>
          <td><strong>Services Layer</strong></td>
          <td>FHIR API communication, data transformation</td>
          <td><code>encounterService</code>, <code>departmentService</code></td>
        </tr>
        <tr>
          <td><strong>FHIR API</strong></td>
          <td>Data persistence, validation</td>
          <td>Medplum Cloud (Patient, Encounter, Coverage)</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3 id="ui-components-detail">UI Components (Detailed)</h3>

  <h4>RegistrationVisitModal</h4>
  <p>
    Main modal for visit registration, combining wizard and forms.
  </p>
  <div class="doc-table-container" id="ui-components-table">
    <table class="doc-table">
      <thead>
        <tr>
          <th>Element</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>SearchPanel</code></td>
          <td>Patient search panel (by ID/name)</td>
        </tr>
        <tr>
          <td><code>PatientForm</code></td>
          <td>New patient registration form</td>
        </tr>
        <tr>
          <td><code>PatientTable</code></td>
          <td>Registered patients table with pagination</td>
        </tr>
        <tr>
          <td><code>RegistrationVisitModal</code></td>
          <td>Visit registration wizard</td>
        </tr>
      </tbody>
    </table>
    <button class="doc-view-link" onclick="goToScreenshot()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
      </svg>
      View on interface
    </button>
  </div>

  <h4>PatientForm</h4>
  <p>
    Patient data entry form with <strong>4 EMRFormSection components</strong> (accordion-style), total <strong>31 fields</strong>:
  </p>

  <!-- Section 1: Personal Data -->
  <div class="doc-form-section">
    <div class="doc-form-section-header">
      <span class="doc-form-section-number">1</span>
      <span class="doc-form-section-title">Personal Data</span>
      <span class="doc-form-section-badge">8 fields</span>
    </div>
    <div class="doc-table-container">
      <table class="doc-table">
        <thead>
          <tr>
            <th>Field</th>
            <th>Type</th>
            <th>Validation</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Visit Type</strong></td>
            <td>Select</td>
            <td>Required (ambulatory / stationary / emergency)</td>
          </tr>
          <tr>
            <td><strong>Unknown Patient</strong></td>
            <td>Toggle</td>
            <td>When enabled, name and ID are auto-generated</td>
          </tr>
          <tr>
            <td><strong>Personal ID</strong></td>
            <td>Text</td>
            <td>Exactly 11 digits, numbers only</td>
          </tr>
          <tr>
            <td><strong>First Name</strong></td>
            <td>Text</td>
            <td>Required (unless unknown patient)</td>
          </tr>
          <tr>
            <td><strong>Last Name</strong></td>
            <td>Text</td>
            <td>Required (unless unknown patient)</td>
          </tr>
          <tr>
            <td><strong>Father's Name</strong></td>
            <td>Text</td>
            <td>Optional</td>
          </tr>
          <tr>
            <td><strong>Birth Date</strong></td>
            <td>Date</td>
            <td>Not in future, not older than 120 years</td>
          </tr>
          <tr>
            <td><strong>Gender</strong></td>
            <td>Select</td>
            <td>Required (male / female / other / unknown)</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Section 2: Contact -->
  <div class="doc-form-section">
    <div class="doc-form-section-header">
      <span class="doc-form-section-number">2</span>
      <span class="doc-form-section-title">Contact Information</span>
      <span class="doc-form-section-badge">3 fields</span>
    </div>
    <div class="doc-table-container">
      <table class="doc-table">
        <thead>
          <tr>
            <th>Field</th>
            <th>Type</th>
            <th>Validation</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Phone</strong></td>
            <td>Phone</td>
            <td>International format, default: +995</td>
          </tr>
          <tr>
            <td><strong>Email</strong></td>
            <td>Email</td>
            <td>RFC 5322 format</td>
          </tr>
          <tr>
            <td><strong>Address</strong></td>
            <td>Text</td>
            <td>Optional</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Section 3: Additional -->
  <div class="doc-form-section">
    <div class="doc-form-section-header">
      <span class="doc-form-section-number">3</span>
      <span class="doc-form-section-title">Additional Details</span>
      <span class="doc-form-section-badge">10 fields</span>
    </div>
    <div class="doc-table-container">
      <table class="doc-table">
        <thead>
          <tr>
            <th>Field</th>
            <th>Type</th>
            <th>Validation</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Marital Status</strong></td>
            <td>Select</td>
            <td>S / M / D / W (Single, Married, Divorced, Widowed)</td>
          </tr>
          <tr>
            <td><strong>Citizenship</strong></td>
            <td>Select</td>
            <td>ISO 3166 country code, default: GE</td>
          </tr>
          <tr>
            <td><strong>Workplace</strong></td>
            <td>Text</td>
            <td>Optional</td>
          </tr>
          <tr>
            <td><strong>Work Address</strong></td>
            <td>Text</td>
            <td>Optional</td>
          </tr>
          <tr>
            <td><strong>City</strong></td>
            <td>Text</td>
            <td>Optional</td>
          </tr>
          <tr>
            <td><strong>District</strong></td>
            <td>Text</td>
            <td>Optional</td>
          </tr>
          <tr>
            <td><strong>Building</strong></td>
            <td>Text</td>
            <td>Optional</td>
          </tr>
          <tr>
            <td><strong>Region</strong></td>
            <td>Text</td>
            <td>Optional</td>
          </tr>
          <tr>
            <td><strong>Education</strong></td>
            <td>Select</td>
            <td>elementary / secondary / higher / postgraduate</td>
          </tr>
          <tr>
            <td><strong>Family Relationship</strong></td>
            <td>Text</td>
            <td>Optional</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Section 4: Representative -->
  <div class="doc-form-section">
    <div class="doc-form-section-header">
      <span class="doc-form-section-number">4</span>
      <span class="doc-form-section-title">Representative / Guardian</span>
      <span class="doc-form-section-badge">9 fields</span>
    </div>
    <div class="doc-table-container">
      <table class="doc-table">
        <thead>
          <tr>
            <th>Field</th>
            <th>Type</th>
            <th>Validation</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Relationship to Patient</strong></td>
            <td>Select</td>
            <td>MTH / FTH / SIS / BRO / GRMTH / GRFTH / SPS / CHILD / GUARD</td>
          </tr>
          <tr>
            <td><strong>Personal ID</strong></td>
            <td>Text</td>
            <td>Exactly 11 digits</td>
          </tr>
          <tr>
            <td><strong>First Name</strong></td>
            <td>Text</td>
            <td>Optional</td>
          </tr>
          <tr>
            <td><strong>Last Name</strong></td>
            <td>Text</td>
            <td>Optional</td>
          </tr>
          <tr>
            <td><strong>Gender</strong></td>
            <td>Select</td>
            <td>male / female / other</td>
          </tr>
          <tr>
            <td><strong>Birth Date</strong></td>
            <td>Date</td>
            <td>Not in future, not older than 120 years</td>
          </tr>
          <tr>
            <td><strong>Phone</strong></td>
            <td>Phone</td>
            <td>International format, default: +995</td>
          </tr>
          <tr>
            <td><strong>Marital Status</strong></td>
            <td>Select</td>
            <td>S / M / D / W</td>
          </tr>
          <tr>
            <td><strong>Address</strong></td>
            <td>Text</td>
            <td>Optional</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="doc-callout doc-callout-info doc-callout-simple">
    <strong>Draft Autosave:</strong>
    Form data is automatically saved to <code>localStorage</code> with <strong>1-second debounce</strong>. Data is restored on page refresh.
  </div>

  <h4>RegistrationVisitWizard</h4>
  <p>
    <strong>4-step wizard</strong> for visit registration:
  </p>
  <div class="doc-table-container">
    <table class="doc-table">
      <thead>
        <tr>
          <th>Step</th>
          <th>Description</th>
          <th>Required</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>1. Registration</strong></td>
          <td>Visit type, department, doctor, referral type</td>
          <td>Yes</td>
        </tr>
        <tr>
          <td><strong>2. Insurance</strong></td>
          <td>Select up to 3 insurers + guarantee letter</td>
          <td>No (optional)</td>
        </tr>
        <tr>
          <td><strong>3. Demographics</strong></td>
          <td>Address, education, employment</td>
          <td>No (optional)</td>
        </tr>
        <tr>
          <td><strong>4. Confirmation</strong></td>
          <td>Review data and save</td>
          <td>Yes</td>
        </tr>
      </tbody>
    </table>
    <button class="doc-view-link" onclick="goToWizardScreenshot()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
      </svg>
      View on interface
    </button>
  </div>

  <h3 id="validation-system">Validation System</h3>
  <p>
    Form validation is performed in real-time using the <code>validators</code> utility module.
  </p>

  <div class="doc-table-container">
    <table class="doc-table">
      <thead>
        <tr>
          <th>Field</th>
          <th>Rule</th>
          <th>Error Message</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Personal ID</strong></td>
          <td>Exactly 11 digits (<code>/^\d{11}$/</code>)</td>
          <td>"Personal ID must contain 11 digits"</td>
        </tr>
        <tr>
          <td><strong>Email</strong></td>
          <td>RFC 5322 format</td>
          <td>"Invalid email format"</td>
        </tr>
        <tr>
          <td><strong>Birth Date</strong></td>
          <td>Not in future, not older than 120 years</td>
          <td>"Date cannot be in the future"</td>
        </tr>
        <tr>
          <td><strong>Phone</strong></td>
          <td>International format (+995...)</td>
          <td>"Invalid phone format"</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h4>Duplicate Detection</h4>
  <p>When entering a personal ID, the system automatically checks if such a patient exists:</p>
  <ul class="doc-list">
    <li>If found - comparison window appears</li>
    <li>You can choose the existing patient or create a new one</li>
    <li>Duplicate records are prevented</li>
  </ul>

  <h3 id="data-flow">Data Flow</h3>
  <p>
    Data movement is <strong>unidirectional</strong>:
  </p>
  <pre><code>UI Component -> useRegistrationVisitForm hook -> Service -> Medplum FHIR API</code></pre>

  <div class="doc-table-container">
    <table class="doc-table">
      <thead>
        <tr>
          <th>Process</th>
          <th>Layer</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Form Fill</strong></td>
          <td>UI -> Hook</td>
          <td><code>onChange</code> -> <code>setFormData</code> state update</td>
        </tr>
        <tr>
          <td><strong>Draft Save</strong></td>
          <td>Hook -> localStorage</td>
          <td>1-second debounce, JSON serialization</td>
        </tr>
        <tr>
          <td><strong>Patient Save</strong></td>
          <td>Hook -> Service -> API</td>
          <td><code>medplum.createResource('Patient', data)</code></td>
        </tr>
        <tr>
          <td><strong>Visit Creation</strong></td>
          <td>Hook -> Service -> API</td>
          <td><code>encounterService.createEncounter()</code></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="doc-callout doc-callout-info doc-callout-simple">
    <strong>Recent Patients Cache:</strong>
    Last <strong>10</strong> visited patients are stored in localStorage via <code>recentPatientsService</code> (FIFO - First In First Out).
  </div>

  <h3 id="fhir-resources">FHIR Resource Structure</h3>
  <p>
    The system uses <strong>FHIR R4</strong> standard. Main resources:
  </p>

  <h4>Patient Resource</h4>
  <div class="doc-table-container">
    <table class="doc-table">
      <thead>
        <tr>
          <th>Field</th>
          <th>FHIR Path</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Personal ID</td>
          <td><code>identifier[system="NATIONAL_ID"]</code></td>
          <td>11-digit unique identifier</td>
        </tr>
        <tr>
          <td>First Name</td>
          <td><code>name[0].given[0]</code></td>
          <td>Patient's first name</td>
        </tr>
        <tr>
          <td>Last Name</td>
          <td><code>name[0].family</code></td>
          <td>Patient's last name</td>
        </tr>
        <tr>
          <td>Birth Date</td>
          <td><code>birthDate</code></td>
          <td>ISO 8601 format (YYYY-MM-DD)</td>
        </tr>
        <tr>
          <td>Gender</td>
          <td><code>gender</code></td>
          <td><code>male</code> | <code>female</code> | <code>other</code> | <code>unknown</code></td>
        </tr>
        <tr>
          <td>Phone</td>
          <td><code>telecom[system="phone"]</code></td>
          <td>Contact number</td>
        </tr>
        <tr>
          <td>Email</td>
          <td><code>telecom[system="email"]</code></td>
          <td>Email address</td>
        </tr>
        <tr>
          <td>Unknown Patient</td>
          <td><code>extension[UNKNOWN_PATIENT]</code></td>
          <td><code>valueBoolean: true</code></td>
        </tr>
      </tbody>
    </table>
  </div>

  <h4>Encounter Resource</h4>
  <div class="doc-table-container">
    <table class="doc-table">
      <thead>
        <tr>
          <th>Field</th>
          <th>FHIR Path</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Patient</td>
          <td><code>subject</code></td>
          <td><code>Reference(Patient)</code></td>
        </tr>
        <tr>
          <td>Status</td>
          <td><code>status</code></td>
          <td><code>planned</code> | <code>arrived</code> | <code>in-progress</code> | <code>finished</code></td>
        </tr>
        <tr>
          <td>Class</td>
          <td><code>class</code></td>
          <td><code>AMB</code> (ambulatory) | <code>IMP</code> (inpatient)</td>
        </tr>
        <tr>
          <td>Period</td>
          <td><code>period.start</code></td>
          <td>Visit start time</td>
        </tr>
        <tr>
          <td>Registration #</td>
          <td><code>identifier[system="REG_NUMBER"]</code></td>
          <td>Auto-generated unique number</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h4>Coverage Resource (Insurance)</h4>
  <div class="doc-table-container">
    <table class="doc-table">
      <thead>
        <tr>
          <th>Field</th>
          <th>FHIR Path</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Beneficiary</td>
          <td><code>beneficiary</code></td>
          <td><code>Reference(Patient)</code></td>
        </tr>
        <tr>
          <td>Insurer</td>
          <td><code>payor</code></td>
          <td><code>Reference(Organization)</code></td>
        </tr>
        <tr>
          <td>Status</td>
          <td><code>status</code></td>
          <td><code>active</code> | <code>cancelled</code></td>
        </tr>
        <tr>
          <td>Period</td>
          <td><code>period</code></td>
          <td>Insurance validity period</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h4>RelatedPerson Resource (Representative)</h4>
  <div class="doc-table-container">
    <table class="doc-table">
      <thead>
        <tr>
          <th>Field</th>
          <th>FHIR Path</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Patient</td>
          <td><code>patient</code></td>
          <td><code>Reference(Patient)</code></td>
        </tr>
        <tr>
          <td>Relationship</td>
          <td><code>relationship</code></td>
          <td><code>parent</code> | <code>spouse</code> | <code>guardian</code> | ...</td>
        </tr>
        <tr>
          <td>Name</td>
          <td><code>name</code></td>
          <td>Representative's name/surname</td>
        </tr>
        <tr>
          <td>Phone</td>
          <td><code>telecom</code></td>
          <td>Contact information</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3 id="services-functionality">Services Functionality</h3>

  <h4>encounterService</h4>
  <p>Visit (Encounter) management service:</p>
  <div class="doc-table-container">
    <table class="doc-table">
      <thead>
        <tr>
          <th>Function</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>createEncounter()</code></td>
          <td>Create new visit with registration number</td>
        </tr>
        <tr>
          <td><code>updateEncounter()</code></td>
          <td>Update visit data</td>
        </tr>
        <tr>
          <td><code>generateRegistrationNumber()</code></td>
          <td>Generate unique registration number (format: a-1234-2025 for ambulatory)</td>
        </tr>
        <tr>
          <td><code>getEncountersByPatient()</code></td>
          <td>Patient visit history</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h4>departmentService</h4>
  <p>Department management and validation:</p>
  <div class="doc-table-container">
    <table class="doc-table">
      <thead>
        <tr>
          <th>Function</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>getDepartments()</code></td>
          <td>List of active departments</td>
        </tr>
        <tr>
          <td><code>isPatientEligibleDepartment()</code></td>
          <td>Check patient eligibility (age, gender)</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h4>unknownPatientService</h4>
  <p>Unknown patient registration:</p>
  <div class="doc-table-container">
    <table class="doc-table">
      <thead>
        <tr>
          <th>Function</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>generateUnknownPatientName()</code></td>
          <td>"Unknown #N" name generation (e.g.: "Unknown #1", "Unknown #2")</td>
        </tr>
        <tr>
          <td><code>generateUnknownPatientIdentifier()</code></td>
          <td>Temporary ID generation (format: UNK-2025-001)</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h4>registrationStatusService</h4>
  <p>Registration status management:</p>
  <div class="doc-table-container">
    <table class="doc-table">
      <thead>
        <tr>
          <th>Status</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>planned</code></td>
          <td>Planned visit</td>
        </tr>
        <tr>
          <td><code>arrived</code></td>
          <td>Patient arrived</td>
        </tr>
        <tr>
          <td><code>in-progress</code></td>
          <td>Visit in progress</td>
        </tr>
        <tr>
          <td><code>finished</code></td>
          <td>Completed</td>
        </tr>
        <tr>
          <td><code>cancelled</code></td>
          <td>Cancelled</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="doc-callout doc-callout-info doc-callout-simple">
    <strong>FHIR ValueSet:</strong>
    Statuses come from FHIR ValueSet and correspond to the <code>encounter-status</code> standard code system.
  </div>

  <h3 id="authentication">Authentication System</h3>
  <p>
    The system uses <strong>Medplum OAuth 2.0</strong> authorization:
  </p>
  <div class="doc-table-container">
    <table class="doc-table">
      <thead>
        <tr>
          <th>Component</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>OAuth 2.0 Flow</strong></td>
          <td>Authorization Code Grant with PKCE</td>
        </tr>
        <tr>
          <td><strong>Token Type</strong></td>
          <td>JWT (JSON Web Token)</td>
        </tr>
        <tr>
          <td><strong>Token Storage</strong></td>
          <td>Medplum SDK (secure storage)</td>
        </tr>
        <tr>
          <td><strong>Access Control</strong></td>
          <td>Project-based permissions</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3 id="unknown-patient">Unknown Patient Registration</h3>
  <p>
    For emergency cases when the patient is unconscious or identity cannot be established.
  </p>
  <p><strong>Auto-generated:</strong></p>
  <ul class="doc-list">
    <li><strong>Temporary ID:</strong> UNK-2026-001 format</li>
    <li><strong>System Name:</strong> "Unknown #1", "Unknown #2"...</li>
    <li><strong>Arrival Time:</strong> Current date and time</li>
  </ul>
  <p>
    <strong>Important:</strong> Unknown patient data should be updated as soon as identity is established. The system shows reminders for such patients.
  </p>

</div>
